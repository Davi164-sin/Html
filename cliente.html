<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro R√°pido</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #eee; font-size: 14px; }
        .box { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #333; color: white; }
        .btn-del { background: #ff4d4d; padding: 5px 10px; width: auto; font-size: 12px; }
    </style>
</head>
<body>

    <div class="box">
        <h3>üìù Nuevo Registro</h3>
        <input type="text" id="n" placeholder="Nombre completo">
        <input type="number" id="d" placeholder="Documento / ID">
        <select id="t">
            <option value="General">General</option>
            <option value="VIP">VIP</option>
        </select>
        <button onclick="add()">REGISTRAR</button>
    </div>

    <div class="box">
        <h3>üìä Total: <span id="count">0</span></h3>
        <table>
            <thead><tr><th>Nombre</th><th>ID</th><th>Tipo</th><th>Acci√≥n</th></tr></thead>
            <tbody id="list"></tbody>
        </table>
        <br>
        <button style="background:#555" onclick="csv()">üì• DESCARGAR EXCEL (CSV)</button>
        <button style="background:#cc0000; margin-top: 10px;" onclick="clearAll()">üóëÔ∏è BORRAR TODO</button>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('regs')) || [];
    const MI_API = "https://https://html-heqnmo2xs-david-s-projects-fe8f3f6b.vercel.app/api/tasks";

    function upd() {
        const list = document.getElementById('list');
        list.innerHTML = db.map((p, i) => `<tr>
            <td>${p.n}</td>
            <td>${p.d}</td>
            <td>${p.t}</td>
            <td><button class="btn-del" onclick="del(${i})">X</button></td>
        </tr>`).join('');
        document.getElementById('count').innerText = db.length;
        localStorage.setItem('regs', JSON.stringify(db));
    }

    async function add() {
        const n = document.getElementById('n').value, d = document.getElementById('d').value, t = document.getElementById('t').value;
        if(!n || !d) return alert('Faltan datos');
        
        const nuevo = {n, d, t};
        db.unshift(nuevo);
        
        // Enviar a la API
        try {
            fetch(MI_API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nombre: `${n} - ID: ${d} (${t})` })
            });
        } catch(e) { console.log("Offline"); }

        document.getElementById('n').value = ''; 
        document.getElementById('d').value = '';
        upd();
    }

    function del(i) {
        if(confirm('¬øEliminar?')) { db.splice(i, 1); upd(); }
    }

    function clearAll() {
        if(confirm('¬øBorrar todo el historial?')) { db = []; upd(); }
    }

    // ESTA FUNCI√ìN ES LA QUE ARREGLA EL EXCEL
    function csv() {
        if(db.length === 0) return alert('No hay datos');
        
        // 1. "sep=," le dice a Excel que use comas para las columnas
        // 2. '\ufeff' es el BOM para que Excel lea bien los acentos
        let csvContent = "\ufeffsep=,\nNombre,ID,Tipo\n";
        
        db.forEach(p => {
            csvContent += `${p.n},${p.d},${p.t}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        link.setAttribute("href", url);
        link.setAttribute("download", "reporte_asistentes.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    upd();
</script>
</body>
</html>
