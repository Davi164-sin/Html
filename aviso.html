<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soporte Pro - Full Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 450px; margin: auto; background: #1e1e1e; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        
        .nav { display: flex; background: #000; padding: 10px 0; }
        .nav button { flex: 1; padding: 10px; border: none; color: #666; background: none; cursor: pointer; font-weight: bold; }
        .nav button.active { color: #466eea; border-bottom: 2px solid #466eea; }

        .content { padding: 20px; text-align: center; }
        .section { display: none; }
        .section.active { display: block; }

        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #2d2d2d; color: white; box-sizing: border-box; font-size: 15px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; font-size: 15px; }
        .btn-blue { background: #466eea; color: white; }
        .btn-green { background: #25d366; color: white; }
        .btn-red { background: #ff4444; color: white; margin-top: 20px; font-size: 11px; }

        #bloqueo-pantalla {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; padding: 20px; box-sizing: border-box;
        }

        .card { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 4px solid #466eea; text-align: left; }
        #qrcode { margin: 20px auto; background: white; padding: 10px; border-radius: 10px; display: none; }
    </style>
</head>
<body>

    <div id="bloqueo-pantalla">
        <h1 style="color: #ff4444; font-size: 50px; margin: 0;">游</h1>
        <h2 style="color: white;">SISTEMA BLOQUEADO</h2>
        <p style="color: #aaa;">Licencia expirada. Ingrese c칩digo de activaci칩n.</p>
        <input type="text" id="key-bloqueo" placeholder="C칩digo Anual" style="text-align: center; width: 80%;">
        <button class="btn btn-blue" onclick="activarDesdeBloqueo()" style="width: 80%;">ACTIVAR AHORA</button>
    </div>

    <div class="container" id="main-content">
        <div class="nav">
            <button class="active" onclick="tab('reg', event)">REGISTRO</button>
            <button onclick="tab('rep', event)">VENTAS</button>
            <button onclick="tab('lic', event)">LICENCIA</button>
        </div>

        <div class="content">
            <div id="reg" class="section active">
                <input type="text" id="cliente" placeholder="Nombre del Cliente">
                <input type="text" id="tel" placeholder="WhatsApp (ej: 573...)">
                <input type="text" id="mod" placeholder="Modelo del Celular">
                <input type="text" id="dan" placeholder="Da침o / Reparaci칩n">
                <input type="number" id="pre" placeholder="Precio de Venta $">
                
                <button class="btn btn-blue" onclick="guardarTodo()">1. GUARDAR Y GENERAR QR</button>
                <div id="qrcode" style="margin-inline: auto;"></div>
                <button class="btn btn-green" id="btn-wa" style="display:none;" onclick="enviarWhatsApp()">2. ENVIAR POR WHATSAPP</button>
            </div>

            <div id="rep" class="section">
                <h3>Ventas Acumuladas</h3>
                <div class="card"><p id="t-mes">Cargando mes...</p></div>
                <div class="card" style="border-left-color: #25d366;"><p id="t-a침o">Cargando a침o...</p></div>
            </div>

            <div id="lic" class="section">
                <h3>Estado de Suscripci칩n</h3>
                <div class="card">
                    <p id="venc-info" style="font-weight: bold;">---</p>
                    <p id="dias-info" style="font-size: 14px; color: #aaa;">---</p>
                </div>
                <button class="btn btn-red" onclick="simularVencimiento()">游빍 PROBAR BLOQUEO (VENCER AHORA)</button>
            </div>
        </div>
    </div>

    <script>
        const CLAVE = "VENTAS-2026-PRO";
        let linkFactura = "";

        // --- SEGURIDAD ---
        function verificar() {
            let venc = localStorage.getItem('venc_app');
            if (!venc) {
                let d = new Date();
                d.setDate(d.getDate() + 2); // 2 d칤as de prueba inicial
                localStorage.setItem('venc_app', d.toISOString());
            }
            let hoy = new Date();
            let fin = new Date(localStorage.getItem('venc_app'));
            let dias = Math.ceil((fin - hoy) / (1000 * 60 * 60 * 24));

            if (hoy > fin) {
                document.getElementById('bloqueo-pantalla').style.display = 'flex';
            } else {
                document.getElementById('venc-info').innerText = "Vencimiento: " + fin.toLocaleDateString();
                document.getElementById('dias-info').innerText = "Le quedan " + (dias > 0 ? dias : 0) + " d칤as de uso.";
            }
        }

        function activarDesdeBloqueo() {
            const val = document.getElementById('key-bloqueo').value;
            if (val === CLAVE) {
                let d = new Date();
                d.setFullYear(d.getFullYear() + 1);
                localStorage.setItem('venc_app', d.toISOString());
                alert("춰Activado por 1 a침o!");
                location.reload();
            } else { alert("C칩digo incorrecto"); }
        }

        function simularVencimiento() {
            let ayer = new Date();
            ayer.setDate(ayer.getDate() - 1);
            localStorage.setItem('venc_app', ayer.toISOString());
            location.reload();
        }

        // --- VENTAS Y WHATSAPP ---
        function guardarTodo() {
            const cli = document.getElementById('cliente').value;
            const tel = document.getElementById('tel').value;
            const mod = document.getElementById('mod').value;
            const dan = document.getElementById('dan').value;
            const pre = document.getElementById('pre').value;

            if(!cli || !mod || !pre) return alert("Faltan datos");

            // Guardar en "Base de Datos"
            let db = JSON.parse(localStorage.getItem('ventas_tecnico')) || [];
            db.push({ p: parseFloat(pre), f: new Date().toISOString() });
            localStorage.setItem('ventas_tecnico', JSON.stringify(db));

            // Crear Link Factura
            const base = window.location.href.substring(0, window.location.href.lastIndexOf("/") + 1);
            linkFactura = `${base}usurio.html?cliente=${encodeURIComponent(cli)}&modelo=${encodeURIComponent(mod)}&dano=${encodeURIComponent(dan)}&precio=${pre}`;

            // Mostrar QR
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = "";
            qrDiv.style.display = "block";
            new QRCode(qrDiv, { text: linkFactura, width: 150, height: 150 });

            // Mostrar Bot칩n WhatsApp
            document.getElementById('btn-wa').style.display = "block";
            alert("Venta guardada y QR generado");
        }

        function enviarWhatsApp() {
            const tel = document.getElementById('tel').value;
            const mod = document.getElementById('mod').value;
            if(!tel) return alert("Escribe el tel칠fono del cliente");

            const mensaje = `춰Hola! Tu ${mod} ya est치 listo para entrega.\n\nPuedes ver el detalle aqu칤: ${linkFactura}`;
            window.open(`https://wa.me/${tel}?text=${encodeURIComponent(mensaje)}`, '_blank');
        }

        function tab(id, e) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            e.target.classList.add('active');
            if(id === 'rep') calcularReporte();
        }

        function calcularReporte() {
            const db = JSON.parse(localStorage.getItem('ventas_tecnico')) || [];
            const hoy = new Date();
            let m = 0, a = 0;
            db.forEach(v => {
                const f = new Date(v.f);
                if(f.getFullYear() === hoy.getFullYear()) {
                    a += v.p;
                    if(f.getMonth() === hoy.getMonth()) m += v.p;
                }
            });
            document.getElementById('t-mes').innerText = `Mensual: $ ${m.toLocaleString()}`;
            document.getElementById('t-a침o').innerText = `Anual: $ ${a.toLocaleString()}`;
        }

        window.onload = verificar;
    </script>
</body>
</html>
