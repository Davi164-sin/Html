<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soporte Pro - Sistema Blindado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --blue: #466eea; --green: #25d366; --red: #ff4444; --bg: #121212; --card: #1e1e1e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #e0e0e0; margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; background: var(--card); border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        
        .nav { display: flex; background: #000; overflow-x: auto; scrollbar-width: none; }
        .nav button { flex: 1; padding: 15px; border: none; color: #666; background: none; cursor: pointer; font-weight: bold; font-size: 10px; text-transform: uppercase; min-width: 100px; }
        .nav button.active { color: var(--blue); border-bottom: 2px solid var(--blue); }

        .content { padding: 20px; }
        .section { display: none; }
        .section.active { display: block; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #2d2d2d; color: white; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        
        .card { background: #2d2d2d; padding: 15px; border-radius: 12px; margin-top: 10px; border-left: 4px solid var(--blue); }
        .inv-item { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 12px; margin-bottom: 8px; border-radius: 10px; border: 1px solid #333; }
        .low-stock { border: 1px solid var(--red); background: rgba(255, 68, 68, 0.1); }
        .badge { padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; }
        
        table { width: 100%; font-size: 12px; margin-top: 15px; border-collapse: collapse; }
        th { text-align: left; color: #888; padding: 8px; border-bottom: 1px solid #444; }
        td { padding: 8px; border-bottom: 1px solid #333; }

        #bloqueo-pantalla { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="bloqueo-pantalla">
        <h1 style="color: var(--red); font-size: 50px; margin:0;">ðŸ”’</h1>
        <h2>SISTEMA BLOQUEADO</h2>
        <p style="color:#888;">Licencia expirada. Ingrese su cÃ³digo anual.</p>
        <input type="text" id="key-bloqueo" placeholder="CÃ³digo de ActivaciÃ³n" style="text-align: center; width: 80%;">
        <button class="btn btn-blue" onclick="activarLicencia()" style="width: 80%;">ACTIVAR AHORA</button>
    </div>

    <div class="container">
        <div class="nav">
            <button class="active" onclick="tab('reg', event)">Venta</button>
            <button onclick="tab('inv', event)">Inventario</button>
            <button onclick="tab('rep', event)">Caja</button>
            <button onclick="tab('lic', event)">Licencia</button>
        </div>

        <div class="content">
            <div id="reg" class="section active">
                <input type="text" id="cliente" placeholder="Nombre Cliente">
                <input type="text" id="tel" placeholder="WhatsApp">
                <p style="text-align: left; font-size: 11px; margin: 10px 0 0 5px; color: #888;">Producto / Accesorio:</p>
                <select id="select-prod" onchange="autoPrecio()">
                    <option value="">-- Servicio TÃ©cnico solamente --</option>
                </select>
                <input type="number" id="pre" placeholder="Precio Total $">
                <button class="btn btn-blue" onclick="procesarVenta()">GUARDAR Y DESCONTAR</button>
                <div id="qrcode" style="margin: 15px auto; background: white; padding: 10px; display: none; width: fit-content; border-radius:10px;"></div>
                <button id="btn-wa" class="btn btn-green" style="display:none;" onclick="enviarWA()">ENVIAR RECIBO WHATSAPP</button>
            </div>

            <div id="inv" class="section">
                <h3>AÃ±adir al Stock</h3>
                <input type="text" id="inv-nombre" placeholder="Producto (Bafle, Pila, etc)">
                <input type="number" id="inv-cant" placeholder="Cantidad">
                <input type="number" id="inv-precio" placeholder="Precio Sugerido $">
                <button class="btn btn-blue" onclick="agregarArticulo()">GUARDAR EN INVENTARIO</button>
                <h4 style="margin-top:20px;">Existencias Actuales</h4>
                <div id="lista-inventario"></div>
            </div>

            <div id="rep" class="section">
                <div class="card"><small>ESTE MES</small><h2 id="t-mes">$ 0</h2></div>
                <div class="card" style="border-left-color: var(--green);"><small>ESTE AÃ‘O</small><h2 id="t-aÃ±o">$ 0</h2></div>
                <h4>Ãšltimas 5 Ventas</h4>
                <table>
                    <thead><tr><th>Cliente</th><th>Valor</th><th>Fecha</th></tr></thead>
                    <tbody id="historial-ventas"></tbody>
                </table>
            </div>

            <div id="lic" class="section">
                <div class="card">
                    <p id="venc-info">---</p>
                    <p id="dias-info" style="color:#888; font-size:12px;">---</p>
                </div>
                <button class="btn" style="background:#333; color:white; font-size:10px;" onclick="simularVencimiento()">ðŸ§ª PROBAR BLOQUEO</button>
            </div>
        </div>
    </div>

    <script>
        // MANTENEMOS LOS NOMBRES DE LAS BASES DE DATOS ORIGINALES PARA NO PERDER INFO
        const CLAVE_MAESTRA = "VENTAS-2026-PRO";
        let linkActual = "";

        // LICENCIA
        function verificarLicencia() {
            let v = localStorage.getItem('APP_VENC'); // Nombre original
            if (!v) { 
                let d = new Date(); d.setDate(d.getDate() + 2); 
                localStorage.setItem('APP_VENC', d.toISOString()); 
            }
            let hoy = new Date(); let fin = new Date(localStorage.getItem('APP_VENC'));
            if (hoy > fin) document.getElementById('bloqueo-pantalla').style.display = 'flex';
            else {
                document.getElementById('venc-info').innerText = "Licencia: " + fin.toLocaleDateString();
                document.getElementById('dias-info').innerText = "DÃ­as restantes: " + Math.ceil((fin - hoy) / (1000 * 60 * 60 * 24));
            }
        }

        function activarLicencia() {
            if (document.getElementById('key-bloqueo').value === CLAVE_MAESTRA) {
                let d = new Date(); d.setFullYear(d.getFullYear() + 1);
                localStorage.setItem('APP_VENC', d.toISOString());
                location.reload();
            } else alert("CÃ³digo Incorrecto");
        }

        function simularVencimiento() {
            let a = new Date(); a.setDate(a.getDate() - 1);
            localStorage.setItem('APP_VENC', a.toISOString());
            location.reload();
        }

        // INVENTARIO
        function agregarArticulo() {
            const nom = document.getElementById('inv-nombre').value;
            const can = parseInt(document.getElementById('inv-cant').value) || 0;
            const pre = parseFloat(document.getElementById('inv-precio').value) || 0;
            if(!nom) return alert("Nombre obligatorio");

            let db = JSON.parse(localStorage.getItem('STOCK_DB')) || []; // Nombre original
            db.push({ id: Date.now(), nom, can, pre });
            localStorage.setItem('STOCK_DB', JSON.stringify(db));
            
            document.getElementById('inv-nombre').value = "";
            document.getElementById('inv-cant').value = "";
            document.getElementById('inv-precio').value = "";
            actualizarTodo();
        }

        function renderInventario() {
            const list = document.getElementById('lista-inventario');
            const db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
            list.innerHTML = db.map(i => `
                <div class="inv-item ${i.can < 5 ? 'low-stock' : ''}">
                    <span><b>${i.nom}</b><br><small>$${i.pre.toLocaleString()}</small></span>
                    <div>
                        <span class="badge" style="background:${i.can < 5 ? 'var(--red)' : 'var(--blue)'}">${i.can} und</span>
                        <button onclick="borrarProd(${i.id})" style="background:none; border:none; color:red; margin-left:10px; cursor:pointer;">âœ•</button>
                    </div>
                </div>
            `).join('');
        }

        function actualizarSelector() {
            const sel = document.getElementById('select-prod');
            const db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
            sel.innerHTML = '<option value="">-- Servicio TÃ©cnico solamente --</option>' + 
                db.map(i => `<option value="${i.id}" data-p="${i.pre}">${i.nom} (Stock: ${i.can})</option>`).join('');
        }

        function autoPrecio() {
            const sel = document.getElementById('select-prod');
            const opt = sel.options[sel.selectedIndex];
            if(opt.dataset.p) document.getElementById('pre').value = opt.dataset.p;
        }

        function borrarProd(id) {
            let db = JSON.parse(localStorage.getItem('STOCK_DB')).filter(i => i.id !== id);
            localStorage.setItem('STOCK_DB', JSON.stringify(db));
            actualizarTodo();
        }

        // VENTAS
        function procesarVenta() {
            const cli = document.getElementById('cliente').value, pre = parseFloat(document.getElementById('pre').value), id = document.getElementById('select-prod').value;
            if(!cli || pre <= 0) return alert("Faltan datos");

            if(id) {
                let db = JSON.parse(localStorage.getItem('STOCK_DB'));
                db = db.map(i => { if(i.id == id && i.can > 0) i.can--; return i; });
                localStorage.setItem('STOCK_DB', JSON.stringify(db));
            }

            let ventas = JSON.parse(localStorage.getItem('VENTAS_DB')) || []; // Nombre original
            ventas.push({ cli, pre, f: new Date().toISOString() });
            localStorage.setItem('VENTAS_DB', JSON.stringify(ventas));

            const base = window.location.href.substring(0, window.location.href.lastIndexOf("/") + 1);
            linkActual = `${base}factura.html?c=${encodeURIComponent(cli)}&p=${pre}`;
            
            const qr = document.getElementById('qrcode');
            qr.innerHTML = ""; qr.style.display="block";
            new QRCode(qr, {text: linkActual, width: 130, height: 130});
            document.getElementById('btn-wa').style.display="block";
            actualizarTodo();
        }

        function enviarWA() {
            window.open(`https://wa.me/${document.getElementById('tel').value}?text=${encodeURIComponent("Hola! AquÃ­ tu recibo: "+linkActual)}`);
        }

        function tab(id, e) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            e.target.classList.add('active');
            if(id === 'rep') calcularCaja();
        }

        function calcularCaja() {
            const v = JSON.parse(localStorage.getItem('VENTAS_DB')) || [];
            const h = new Date(); let m=0, a=0;
            v.forEach(x => {
                let f = new Date(x.f);
                if(f.getFullYear() === h.getFullYear()) { a+=x.pre; if(f.getMonth() === h.getMonth()) m+=x.pre; }
            });
            document.getElementById('t-mes').innerText = "$ " + m.toLocaleString();
            document.getElementById('t-aÃ±o').innerText = "$ " + a.toLocaleString();
            
            const hist = document.getElementById('historial-ventas');
            hist.innerHTML = v.slice(-5).reverse().map(x => `
                <tr><td>${x.cli}</td><td>$${x.pre}</td><td>${new Date(x.f).toLocaleDateString()}</td></tr>
            `).join('');
        }

        function actualizarTodo() {
            renderInventario();
            actualizarSelector();
            calcularCaja();
        }

        window.onload = () => { verificarLicencia(); actualizarTodo(); };
    </script>
</body>
</html>
