<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERVICIO T√âCNICO TABLESCELL-JSV</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --blue: #466eea; --green: #25d366; --red: #ff4444; --bg: #121212; --card: #1e1e1e; --gold: #fbbf24; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; }
        .container { max-width: 450px; margin: auto; background: var(--card); border-radius: 20px; border: 1px solid #333; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .tabs { display: flex; background: #000; overflow-x: auto; }
        .tabs button { flex: 1; padding: 15px; border: none; color: #666; background: none; cursor: pointer; font-weight: bold; font-size: 10px; text-transform: uppercase; min-width: 80px; }
        .tabs button.active { color: var(--blue); border-bottom: 2px solid var(--blue); }
        .content { padding: 15px; }
        .section { display: none; }
        .section.active { display: block; }
        input, select { width: 100%; padding: 12px; margin: 6px 0; border-radius: 10px; border: 1px solid #333; background: #2d2d2d; color: white; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; display: none; }
        .btn-print { background: #6b7280; color: white; display: none; }
        .card-info { background: #252525; padding: 15px; border-radius: 12px; margin-top: 10px; border-left: 4px solid var(--blue); }
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; }
        #qrcode { background: white; padding: 10px; margin: 15px auto; display: none; width: fit-content; border-radius: 10px; }
        #bloqueo { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; }
        #sync-status { font-size: 11px; padding: 8px; text-align: center; background: #1a1a1a; margin: -15px -15px 15px -15px; border-bottom: 1px solid #333; cursor: pointer; }
        #sync-status:hover { opacity: 0.8; }
        #sync-status.online { color: var(--green); }
        #sync-status.offline { color: var(--red); }
        .trend-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #252525; border-radius: 10px; margin-bottom: 8px; border-left: 3px solid var(--green); }
        .trend-rank { background: var(--blue); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
        .trend-info { flex: 1; margin: 0 12px; }
        .trend-price { color: var(--green); font-weight: bold; }
        .profit-badge { background: var(--green); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .cost-badge { background: var(--red); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .inv-item { background: #252525; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--gold); }
        .inv-row { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
        .label-small { color: #999; font-size: 11px; }
        .conte { width: max-content; padding: 10px; border: 1px solid #ccc; border-radius: 10px; margin: auto; }
        h1, h2 { width: 100%; margin: 0; padding: 0; font-family: sans-serif; text-align: center; }

        /* Buscador */
        .search-wrapper { position: relative; margin: 10px 0 4px; }
        .search-wrapper input { padding-left: 38px; padding-right: 36px; margin: 0; border-color: #444; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 15px; pointer-events: none; }
        .search-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #777; font-size: 17px; cursor: pointer; width: auto; padding: 0; margin: 0; display: none; line-height: 1; }
        .search-count { font-size: 11px; color: #888; text-align: right; margin: 4px 2px 8px; min-height: 16px; }
        .no-results { text-align: center; padding: 30px 10px; color: #555; font-size: 13px; }
        .no-results span { font-size: 28px; display: block; margin-bottom: 8px; }

        /* Estilos de impresi√≥n */
        @media print {
            body * { visibility: hidden; }
            #factura-print, #factura-print * { visibility: visible; }
            #factura-print { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
            }
        }
        
        #factura-print {
            display: none;
            background: white;
            color: black;
            padding: 30px;
            max-width: 400px;
            margin: 20px auto;
            font-family: 'Courier New', monospace;
        }
        
        .factura-header {
            text-align: center;
            border-bottom: 2px dashed black;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        
        .factura-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .factura-total {
            border-top: 2px dashed black;
            margin-top: 15px;
            padding-top: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .factura-footer {
            text-align: center;
            margin-top: 20px;
            border-top: 2px dashed black;
            padding-top: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="bloqueo">
        <h1 style="color:var(--red)">üîí LICENCIA EXPIRADA</h1>
        <input type="text" id="key-bloqueo" style="width: 80%; text-align: center;" placeholder="C√≥digo de Activaci√≥n">
        <button class="btn btn-blue" onclick="activar()" style="width: 80%;">ACTIVAR</button>
    </div>
    <div class="conte">
        <h1>SERVICIO T√âCNICO</h1>
        <h2>TABLESCELL-JSV</h2>
    </div>
    <div class="container">
        <div class="tabs">
            <button class="active" onclick="tab('venta', event)">Venta</button>
            <button onclick="tab('inventario', event)">Stock</button>
            <button onclick="tab('estados', event)">Estados</button>
            <button onclick="tab('caja', event)">Caja</button>
            <button onclick="tab('tendencias', event)">Tendencias</button>
        </div>

        <div class="content">
            <div id="sync-status" class="offline" onclick="forzarSync()" title="Click para sincronizar manualmente">‚óè Desconectado</div>

            <div id="venta" class="section active">
                <input type="text" id="cli" placeholder="Nombre del Cliente">
                <input type="text" id="mod" placeholder="Modelo del Celular">
                <input type="text" id="tipo" placeholder="Trabajo (Ej: Pin de carga)">
                <input type="number" id="tel" placeholder="WhatsApp del Cliente">
                <select id="sel-prod" onchange="autoPrecio()">
                    <option value="">-- Solo Mano de Obra --</option>
                </select>
                <input type="number" id="pre" placeholder="Precio Total $">
                <button class="btn btn-blue" onclick="procesarVenta()">REGISTRAR Y DESCONTAR STOCK</button>
                <div id="qrcode"></div>
                <button id="btn-wa" class="btn btn-green" onclick="enviarWA()">ENVIAR RECIBO POR WA</button>
                <button id="btn-print" class="btn btn-print" onclick="imprimirFactura()">üñ®Ô∏è IMPRIMIR FACTURA</button>
            </div>

            <div id="inventario" class="section">
                <h3>Agregar Repuesto</h3>
                <input type="text" id="n-prod" placeholder="Nombre del Repuesto">
                <input type="number" id="c-prod" placeholder="Cantidad">
                <input type="number" id="costo-prod" placeholder="üí∞ Costo de Compra (por unidad) $">
                <input type="number" id="p-prod" placeholder="üíµ Precio de Venta (por unidad) $">
                <button class="btn btn-blue" onclick="guardarStock()">GUARDAR EN STOCK</button>

                <div class="card-info" style="margin-top: 20px; border-left-color: var(--gold);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <div>
                            <div class="label-small">INVERSI√ìN TOTAL</div>
                            <h3 style="margin: 5px 0; color: var(--red);" id="total-inversion">$0</h3>
                        </div>
                        <div>
                            <div class="label-small">GANANCIA POTENCIAL</div>
                            <h3 style="margin: 5px 0; color: var(--green);" id="total-ganancia">$0</h3>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #999; margin-top: 8px;">
                        üìä Si vendes todo el stock actual
                    </div>
                </div>

                <h4 style="margin-top: 20px; margin-bottom: 6px;">Inventario Actual</h4>

                <!-- BUSCADOR -->
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="buscar-prod" placeholder="Buscar repuesto..." oninput="filtrarInventario()">
                    <button class="search-clear" id="btn-clear" onclick="limpiarBusqueda()">‚úï</button>
                </div>
                <div class="search-count" id="search-count"></div>

                <div id="lista-inv"></div>
            </div>

            <div id="estados" class="section">
                <h3>Estado de Reparaciones</h3>
                <div id="lista-estados"></div>
            </div>

            <div id="caja" class="section">
                <div class="card-info"><small>TOTAL MES</small><h2 id="m-val">$ 0</h2></div>
                <div class="card-info" style="border-left-color: var(--green);"><small>TOTAL A√ëO</small><h2 id="a-val">$ 0</h2></div>

                <div class="card-info" style="margin-top: 15px; border-left-color: var(--gold);">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <div class="label-small">GANANCIAS REALES (MES)</div>
                            <h3 style="margin: 5px 0; color: var(--green);" id="ganancia-mes">$0</h3>
                        </div>
                        <div>
                            <div class="label-small">GANANCIAS REALES (A√ëO)</div>
                            <h3 style="margin: 5px 0; color: var(--green);" id="ganancia-ano">$0</h3>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #999; margin-top: 8px;">
                        üí° Precio de venta - Costo del producto
                    </div>
                </div>

                <h4 style="margin-top:20px;">Historial</h4>
                <div id="historial"></div>
            </div>

            <div id="tendencias" class="section">
                <h3>üìä Productos M√°s Vendidos del Mercado</h3>
                <p style="font-size: 12px; color: #999; margin-bottom: 15px;">Repuestos con mayor demanda en el sector de t√©cnicos de celulares</p>

                <div id="lista-tendencias">
                    <div class="trend-item">
                        <div class="trend-rank">1</div>
                        <div class="trend-info"><strong>Pin de Carga / Puerto USB</strong><br><small style="color: #999;">Mayor falla en smartphones</small></div>
                        <div class="trend-price">$15-35</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-rank">2</div>
                        <div class="trend-info"><strong>Bater√≠a / Pila</strong><br><small style="color: #999;">Desgaste natural</small></div>
                        <div class="trend-price">$20-50</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-rank">3</div>
                        <div class="trend-info"><strong>Pantalla LCD / T√°ctil</strong><br><small style="color: #999;">Ca√≠das y golpes</small></div>
                        <div class="trend-price">$40-120</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-rank">4</div>
                        <div class="trend-info"><strong>Flex de Carga</strong><br><small style="color: #999;">Conectividad</small></div>
                        <div class="trend-price">$12-25</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-rank">5</div>
                        <div class="trend-info"><strong>Tapa Trasera / Carcasa</strong><br><small style="color: #999;">Est√©tica y protecci√≥n</small></div>
                        <div class="trend-price">$10-30</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-rank">6</div>
                        <div class="trend-info"><strong>C√°mara Trasera/Frontal</strong><br><small style="color: #999;">Foto y video</small></div>
                        <div class="trend-price">$18-60</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-rank">7</div>
                        <div class="trend-info"><strong>Parlante / Auricular</strong><br><small style="color: #999;">Audio</small></div>
                        <div class="trend-price">$8-20</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-rank">8</div>
                        <div class="trend-info"><strong>Micr√≥fono</strong><br><small style="color: #999;">Llamadas y grabaci√≥n</small></div>
                        <div class="trend-price">$10-22</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-rank">9</div>
                        <div class="trend-info"><strong>Botones Power/Volumen</strong><br><small style="color: #999;">Uso frecuente</small></div>
                        <div class="trend-price">$8-18</div>
                    </div>
                    <div class="trend-item">
                        <div class="trend-rank">10</div>
                        <div class="trend-info"><strong>Vidrio Templado</strong><br><small style="color: #999;">Protecci√≥n pantalla</small></div>
                        <div class="trend-price">$5-15</div>
                    </div>
                </div>

                <div class="card-info" style="margin-top: 20px; border-left-color: var(--green);">
                    <strong>üí° Consejo:</strong><br>
                    <small>Mant√©n stock de estos repuestos para maximizar tus ventas y reducir tiempos de espera.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Factura para imprimir (oculta) -->
    <div id="factura-print"></div>

<script>
    const CLAVE = "VENTAS-2026-PRO";
    const API_URL = "https://html-three-nu.vercel.app/api/sync";
    const SYNC_ID = "tecnico_tablescell";
    let linkRecibo = "";
    let syncInterval;
    let isSyncing = false;
    let ultimaVenta = null;

    // ====== SINCRONIZACI√ìN MEJORADA CON LA API ======
    async function sincronizarConNube() {
        if(isSyncing) return;
        
        isSyncing = true;
        try {
            const stock = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
            const ventas = JSON.parse(localStorage.getItem('VENTAS_DB')) || [];
            
            await fetch(API_URL + '?id=' + SYNC_ID, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ stock, ventas })
            });

            const response = await fetch(API_URL + '?id=' + SYNC_ID);
            const datosNube = await response.json();

            if (datosNube && datosNube.stock && datosNube.ventas) {
                const stockActual = JSON.stringify(stock);
                const ventasActuales = JSON.stringify(ventas);
                const stockNube = JSON.stringify(datosNube.stock);
                const ventasNube = JSON.stringify(datosNube.ventas);
                
                if(stockActual !== stockNube || ventasActuales !== ventasNube) {
                    localStorage.setItem('STOCK_DB', stockNube);
                    localStorage.setItem('VENTAS_DB', ventasNube);
                    actualizarTodo();
                }
            }

            document.getElementById('sync-status').innerText = "‚óè Sincronizado ‚úì";
            document.getElementById('sync-status').className = "online";
        } catch (e) {
            document.getElementById('sync-status').innerText = "‚óè Sin conexi√≥n";
            document.getElementById('sync-status').className = "offline";
        } finally {
            isSyncing = false;
        }
    }

    function forzarSync() {
        sincronizarConNube();
    }

    // ====== BUSCADOR DE INVENTARIO ======
    function filtrarInventario() {
        const busqueda = document.getElementById('buscar-prod').value.toLowerCase().trim();
        document.getElementById('btn-clear').style.display = busqueda ? 'block' : 'none';

        const db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
        const filtrado = busqueda ? db.filter(i => i.nom.toLowerCase().includes(busqueda)) : db;

        const countEl = document.getElementById('search-count');
        countEl.innerText = busqueda
            ? (filtrado.length > 0 ? `${filtrado.length} resultado${filtrado.length !== 1 ? 's' : ''} encontrado${filtrado.length !== 1 ? 's' : ''}` : '')
            : '';

        renderizarInventario(filtrado, busqueda);
    }

    function limpiarBusqueda() {
        document.getElementById('buscar-prod').value = '';
        document.getElementById('btn-clear').style.display = 'none';
        document.getElementById('search-count').innerText = '';
        const db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
        renderizarInventario(db, '');
    }

    function renderizarInventario(items, busqueda) {
        if (items.length === 0 && busqueda) {
            document.getElementById('lista-inv').innerHTML = `
                <div class="no-results">
                    <span>üîç</span>
                    No se encontr√≥ <b>"${busqueda}"</b><br>
                    <small>Intenta con otro nombre</small>
                </div>`;
            return;
        }

        document.getElementById('lista-inv').innerHTML = items.map(i => {
            const costo = i.costo || 0;
            const ganancia = (i.pre || 0) - costo;
            const margen = costo > 0 ? ((ganancia / costo) * 100).toFixed(0) : 0;

            let nombre = i.nom;
            if (busqueda) {
                const regex = new RegExp(`(${busqueda.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                nombre = nombre.replace(regex, '<mark style="background:var(--blue);color:white;border-radius:3px;padding:0 2px;">$1</mark>');
            }

            return `
                <div class="inv-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="font-size: 15px;">${nombre}</strong>
                        <span style="background: var(--blue); padding: 5px 10px; border-radius: 6px; font-weight: bold;">${i.can} und</span>
                    </div>
                    <div class="inv-row">
                        <span class="label-small">Costo unitario:</span>
                        <span class="cost-badge">$${costo.toLocaleString()}</span>
                    </div>
                    <div class="inv-row">
                        <span class="label-small">Precio venta:</span>
                        <span style="color: white; font-weight: bold;">$${i.pre.toLocaleString()}</span>
                    </div>
                    <div class="inv-row">
                        <span class="label-small">Ganancia unitaria:</span>
                        <span class="profit-badge">+$${ganancia.toLocaleString()} (${margen}%)</span>
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #333; font-size: 12px; color: #999;">
                         Inversi√≥n total: <b style="color: var(--red);">$${(costo * i.can).toLocaleString()}</b> |
                         Si vendes todo: <b style="color: var(--green);">$${((i.pre - costo) * i.can).toLocaleString()}</b>
                    </div>
                </div>`;
        }).join('');
    }

    // ====== FUNCIONES PRINCIPALES ======
    function checkLicencia() {
        let v = localStorage.getItem('APP_VENC');
        if (!v) {
            let d = new Date(); d.setDate(d.getDate() + 2);
            localStorage.setItem('APP_VENC', d.toISOString());
        }
        if (new Date() > new Date(localStorage.getItem('APP_VENC'))) {
            document.getElementById('bloqueo').style.display = 'flex';
        }
    }

    function activar() {
        if(document.getElementById('key-bloqueo').value === CLAVE) {
            let d = new Date(); d.setFullYear(d.getFullYear() + 1);
            localStorage.setItem('APP_VENC', d.toISOString());
            location.reload();
        }
    }

    function guardarStock() {
        const n = document.getElementById('n-prod').value;
        const c = parseInt(document.getElementById('c-prod').value);
        const costo = parseFloat(document.getElementById('costo-prod').value);
        const p = parseFloat(document.getElementById('p-prod').value);

        if(!n || isNaN(c)) return alert("Completa los datos");
        if(isNaN(costo) || isNaN(p)) return alert("Ingresa el costo y precio de venta");

        let db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
        db.push({ id: Date.now(), nom: n, can: c, costo: costo, pre: p });
        localStorage.setItem('STOCK_DB', JSON.stringify(db));

        document.getElementById('n-prod').value = '';
        document.getElementById('c-prod').value = '';
        document.getElementById('costo-prod').value = '';
        document.getElementById('p-prod').value = '';

        sincronizarConNube();
        actualizarTodo();
    }

    function autoPrecio() {
        const sel = document.getElementById('sel-prod');
        const precio = sel.options[sel.selectedIndex].dataset.p;
        if(precio) document.getElementById('pre').value = precio;
    }

    function procesarVenta() {
        const cli = document.getElementById('cli').value;
        const mod = document.getElementById('mod').value;
        const tipo = document.getElementById('tipo').value;
        const pre = document.getElementById('pre').value;
        const tel = document.getElementById('tel').value;
        const idProd = document.getElementById('sel-prod').value;

        if(!cli || !pre) return alert("Faltan datos");

        let costoProducto = 0;
        let nombreProducto = 'Mano de obra';

        if(idProd) {
            let db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
            let encontrado = false;
            
            db = db.map(i => {
                if(i.id == idProd) {
                    if(i.can > 0) {
                        i.can -= 1;
                        costoProducto = i.costo || 0;
                        nombreProducto = i.nom;
                        encontrado = true;
                    }
                }
                return i;
            });
            
            if(!encontrado) {
                return alert("‚ö†Ô∏è No hay stock disponible");
            }
            
            localStorage.setItem('STOCK_DB', JSON.stringify(db));
        }

        let ventas = JSON.parse(localStorage.getItem('VENTAS_DB')) || [];
        ventas.push({
            id: Date.now(), cli, mod, tipo,
            pre: Number(pre), costo: costoProducto,
            tel, f: new Date().toISOString(), estado: 'pendiente'
        });
        localStorage.setItem('VENTAS_DB', JSON.stringify(ventas));

        // Guardar √∫ltima venta para impresi√≥n
        ultimaVenta = {
            cliente: cli,
            modelo: mod,
            trabajo: tipo,
            precio: Number(pre),
            costo: costoProducto,
            telefono: tel,
            fecha: new Date().toLocaleString('es-ES'),
            productoNombre: nombreProducto
        };

        sincronizarConNube();

        const base = window.location.href.substring(0, window.location.href.lastIndexOf("/") + 1);
        linkRecibo = `${base}recibo.html?n=${encodeURIComponent(cli)}&m=${encodeURIComponent(mod)}&t=${encodeURIComponent(tipo)}&p=${pre}`;

        const qr = document.getElementById('qrcode');
        qr.innerHTML = ""; qr.style.display = "block";
        new QRCode(qr, { text: linkRecibo, width: 140, height: 140 });
        document.getElementById('btn-wa').style.display = "block";
        document.getElementById('btn-print').style.display = "block";

        document.getElementById('cli').value = '';
        document.getElementById('mod').value = '';
        document.getElementById('tipo').value = '';
        document.getElementById('pre').value = '';
        document.getElementById('tel').value = '';
        document.getElementById('sel-prod').value = '';

        actualizarTodo();
    }

    function enviarWA() {
        const tel = document.getElementById('tel').value;
        window.open(`https://wa.me/${tel}?text=${encodeURIComponent("Hola! Aqu√≠ tienes tu recibo: " + linkRecibo)}`);
    }

    function imprimirFactura() {
        if(!ultimaVenta) {
            alert("‚ö†Ô∏è No hay factura para imprimir");
            return;
        }

        const factura = document.getElementById('factura-print');
        const ganancia = ultimaVenta.precio - ultimaVenta.costo;
        
        factura.innerHTML = `
            <div class="factura-header">
                <h2 style="margin: 0;">TABLESCELL-JSV</h2>
                <p style="margin: 5px 0;">Servicio T√©cnico Especializado</p>
                <p style="margin: 5px 0; font-size: 12px;">üìû WhatsApp: ${ultimaVenta.telefono || 'N/A'}</p>
            </div>
            
            <div style="margin: 20px 0;">
                <div class="factura-row">
                    <span>Fecha:</span>
                    <span>${ultimaVenta.fecha}</span>
                </div>
                <div class="factura-row">
                    <span>Cliente:</span>
                    <span><strong>${ultimaVenta.cliente}</strong></span>
                </div>
                <div class="factura-row">
                    <span>Equipo:</span>
                    <span>${ultimaVenta.modelo || 'N/A'}</span>
                </div>
            </div>

            <div style="border-top: 1px dashed black; border-bottom: 1px dashed black; padding: 15px 0; margin: 15px 0;">
                <div class="factura-row">
                    <span>Servicio:</span>
                    <span>${ultimaVenta.trabajo || 'Reparaci√≥n'}</span>
                </div>
                ${ultimaVenta.productoNombre !== 'Mano de obra' ? `
                <div class="factura-row">
                    <span>Repuesto:</span>
                    <span>${ultimaVenta.productoNombre}</span>
                </div>
                ` : ''}
            </div>

            <div class="factura-total">
                <div class="factura-row">
                    <span>TOTAL A PAGAR:</span>
                    <span>$${ultimaVenta.precio.toLocaleString()}</span>
                </div>
            </div>

            <div class="factura-footer">
                <p style="margin: 5px 0;">¬°Gracias por tu confianza!</p>
                <p style="margin: 5px 0; font-size: 10px;">Garant√≠a seg√∫n tipo de servicio</p>
                <p style="margin: 15px 0 5px; font-size: 10px;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</p>
                <p style="margin: 0; font-size: 10px;">Servicio T√©cnico Profesional</p>
            </div>
        `;
        
        factura.style.display = 'block';
        
        setTimeout(() => {
            window.print();
            setTimeout(() => {
                factura.style.display = 'none';
            }, 500);
        }, 100);
    }

    function cambiarEstado(id, nuevo) {
        let v = JSON.parse(localStorage.getItem('VENTAS_DB'));
        v = v.map(x => { if(x.id == id) x.estado = nuevo; return x; });
        localStorage.setItem('VENTAS_DB', JSON.stringify(v));
        sincronizarConNube();
        actualizarTodo();
    }

    function actualizarTodo() {
        const db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
        const v = JSON.parse(localStorage.getItem('VENTAS_DB')) || [];

        let inversionTotal = 0, gananciaPotencial = 0;
        db.forEach(i => {
            const costo = i.costo || 0;
            inversionTotal += costo * (i.can || 0);
            gananciaPotencial += ((i.pre || 0) - costo) * (i.can || 0);
        });

        document.getElementById('total-inversion').innerText = '$' + inversionTotal.toLocaleString();
        document.getElementById('total-ganancia').innerText = '$' + gananciaPotencial.toLocaleString();

        const sel = document.getElementById('sel-prod');
        sel.innerHTML = '<option value="">-- Solo Mano de Obra --</option>' + db.map(i =>
            `<option value="${i.id}" data-p="${i.pre}">${i.nom} (Stock: ${i.can})</option>`
        ).join('');

        const busqueda = (document.getElementById('buscar-prod').value || '').toLowerCase().trim();
        const filtrado = busqueda ? db.filter(i => i.nom.toLowerCase().includes(busqueda)) : db;
        renderizarInventario(filtrado, busqueda);

        document.getElementById('lista-estados').innerHTML = v.slice().reverse().map(x => `
            <div class="card-info" style="border-left-color:${x.estado=='listo'?'var(--green)':'#f59e0b'}">
                <b>${x.cli}</b> - ${x.mod}<br>
                <small>Estado: ${x.estado.toUpperCase()}</small><br>
                <button onclick="cambiarEstado(${x.id}, 'proceso')" style="font-size:9px; background:var(--blue); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-right:5px;">EN PROCESO</button>
                <button onclick="cambiarEstado(${x.id}, 'listo')" style="font-size:9px; background:var(--green); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">LISTO</button>
            </div>`).join('');

        const h = new Date();
        let m = 0, a = 0, gananciaMes = 0, gananciaAno = 0;

        v.forEach(x => {
            let f = new Date(x.f);
            const ventaTotal = x.pre || 0;
            const costoVenta = x.costo || 0;
            const gananciaVenta = ventaTotal - costoVenta;

            if(f.getFullYear() === h.getFullYear()) {
                a += ventaTotal;
                gananciaAno += gananciaVenta;
                if(f.getMonth() === h.getMonth()) {
                    m += ventaTotal;
                    gananciaMes += gananciaVenta;
                }
            }
        });

        document.getElementById('m-val').innerText = "$ " + m.toLocaleString();
        document.getElementById('a-val').innerText = "$ " + a.toLocaleString();
        document.getElementById('ganancia-mes').innerText = "$" + gananciaMes.toLocaleString();
        document.getElementById('ganancia-ano').innerText = "$" + gananciaAno.toLocaleString();

        document.getElementById('historial').innerHTML = v.slice(-4).reverse().map(x => {
            const ganancia = (x.pre || 0) - (x.costo || 0);
            return `
                <div class="card-info" style="font-size:10px">
                    <div style="display: flex; justify-content: space-between;">
                        <b>${x.cli}</b>
                        <span style="color: var(--green); font-weight: bold;">$${x.pre}</span>
                    </div>
                    ${x.costo > 0 ? `<div style="margin-top: 4px; color: #999;">Ganancia: <span style="color: var(--green);">+$${ganancia.toLocaleString()}</span></div>` : ''}
                </div>`;
        }).join('');
    }

    function tab(id, e) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.target.classList.add('active');
    }

    window.onload = () => {
        checkLicencia();
        sincronizarConNube();
        actualizarTodo();
        syncInterval = setInterval(sincronizarConNube, 3000);
    };
</script>
</body>
</html>
