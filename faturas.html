<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soporte Tech Elite - Pro v3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="stylesheet" href="faturas.css">  
</head>
<body>
  <div class="conte">
  <h1>SOPORTE TENICO</h1> 
  <h2>TABLLESCELL.JSV</h2>
  </div>
  
  
    <div id="login-screen">
        <h3 style="color:var(--blue)">SOPORTE TECH ELITE</h3>
        <p style="color:#888">Acceso Restringido</p>
        <input type="password" id="pass-input" style="width: 250px; text-align: center;" placeholder="Contrase√±a">
        <button class="btn btn-blue" onclick="verificarLogin()" style="width: 250px;">ENTRAR</button>
    </div>

    <div class="container" id="main-app">
        <div class="tabs">
            <button class="active" onclick="tab('venta', event)">Venta</button>
            <button onclick="tab('stock', event)">Stock</button>
            <button onclick="tab('estados', event)">Estados</button>
            <button onclick="tab('caja', event)">Caja</button>
        </div>

        <div class="content">
            <div id="venta" class="section active">
                <input type="text" id="cli" placeholder="Cliente">
                <input type="text" id="mod" placeholder="Modelo">
                <input type="text" id="tipo" placeholder="Trabajo">
                <input type="number" id="tel" placeholder="WhatsApp">
                <select id="sel-prod" onchange="autoPrecio()"></select>
                <input type="number" id="pre" placeholder="Precio Final $">
                <button class="btn btn-blue" onclick="procesarVenta()">REGISTRAR VENTA</button>
                <div id="qrcode"></div>
                <button id="btn-wa" class="btn btn-green" onclick="enviarWA()">ENVIAR RECIBO</button>
            </div>

            <div id="stock" class="section">
                <div class="search-bar">
                    <input type="text" id="bus-stock" placeholder="üîç Buscar repuesto..." oninput="actualizarStock()">
                </div>
                <div id="resumen-inversion" class="stats-grid" style="margin-bottom:15px;">
                    <div class="stat-box"><small>INVERSI√ìN</small><br><b id="total-inv" style="color:var(--red)">$0</b></div>
                    <div class="stat-box"><small>UTILIDAD</small><br><b id="total-gan" style="color:var(--green)">$0</b></div>
                </div>
                <div class="card-info">
                    <input type="text" id="n-prod" placeholder="Nombre Repuesto">
                    <div class="stats-grid">
                        <input type="number" id="costo-prod" placeholder="Costo $">
                        <input type="number" id="venta-prod" placeholder="Venta $">
                    </div>
                    <input type="number" id="c-prod" placeholder="Cantidad">
                    <button class="btn btn-blue" onclick="guardarStock()">AGREGAR AL INVENTARIO</button>
                </div>
                <div id="lista-inv" style="margin-top:15px;"></div>
            </div>

            <div id="estados" class="section">
                <h3>Reparaciones</h3>
                <div id="lista-estados"></div>
            </div>

            <div id="caja" class="section">
                <div class="card-info"><small>TOTAL MES</small><h2 id="m-val">$ 0</h2></div>
                <div class="card-info" style="border-left-color: var(--green);"><small>TOTAL A√ëO</small><h2 id="a-val">$ 0</h2></div>
                <button class="btn" style="background:#333; font-size:10px;" onclick="borrarTodo()">BORRAR TODO EL HISTORIAL</button>
                <div id="historial" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

<script>
    const PASS_CORRECTA = "1234"; // CAMBIA TU CONTRASE√ëA AQU√ç

    function verificarLogin() {
        if(document.getElementById('pass-input').value === PASS_CORRECTA) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            actualizarTodo();
        } else { alert("Acceso denegado"); }
    }

    function guardarStock() {
        const n = document.getElementById('n-prod').value,
              costo = parseFloat(document.getElementById('costo-prod').value) || 0,
              venta = parseFloat(document.getElementById('venta-prod').value) || 0,
              cant = parseInt(document.getElementById('c-prod').value) || 0;

        if(!n || cant <= 0) return alert("Datos incompletos");

        let db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
        db.push({ id: Date.now(), nom: n, costo, pre: venta, can: cant });
        localStorage.setItem('STOCK_DB', JSON.stringify(db));
        
        // Limpiar campos
        ['n-prod','costo-prod','venta-prod','c-prod'].forEach(id => document.getElementById(id).value = "");
        actualizarTodo();
    }

    function actualizarStock() {
        const db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];
        const bus = document.getElementById('bus-stock').value.toLowerCase();
        let invTotal = 0; let ganTotal = 0;

        let html = db.filter(i => i.nom.toLowerCase().includes(bus)).reverse().map(i => {
            const inversionSub = i.costo * i.can;
            const gananciaSub = (i.pre - i.costo) * i.can;
            invTotal += inversionSub;
            ganTotal += gananciaSub;

            return `
                <div class="card-info">
                    <div style="display:flex; justify-content:space-between">
                        <b>${i.nom}</b>
                        <b style="color:var(--blue)">${i.can} und</b>
                    </div>
                    <div style="font-size:11px; margin-top:5px; color:#888">
                        Inversi√≥n: $${inversionSub.toLocaleString()} | 
                        Ganancia: <span style="color:var(--green)">$${gananciaSub.toLocaleString()}</span>
                    </div>
                </div>`;
        }).join('');

        document.getElementById('lista-inv').innerHTML = html;
        document.getElementById('total-inv').innerText = "$" + invTotal.toLocaleString();
        document.getElementById('total-gan').innerText = "$" + ganTotal.toLocaleString();
    }

    function procesarVenta() {
        const cli = document.getElementById('cli').value, mod = document.getElementById('mod').value,
              tipo = document.getElementById('tipo').value, pre = document.getElementById('pre').value,
              tel = document.getElementById('tel').value, idProd = document.getElementById('sel-prod').value;

        if(!cli || !pre) return alert("Faltan datos");

        if(idProd) {
            let db = JSON.parse(localStorage.getItem('STOCK_DB'));
            db = db.map(i => { if(i.id == idProd && i.can > 0) i.can -= 1; return i; });
            localStorage.setItem('STOCK_DB', JSON.stringify(db));
        }

        let ventas = JSON.parse(localStorage.getItem('VENTAS_DB')) || [];
        ventas.push({ id: Date.now(), cli, mod, tipo, pre: Number(pre), tel, f: new Date().toISOString(), estado: 'pendiente' });
        localStorage.setItem('VENTAS_DB', JSON.stringify(ventas));

        const base = window.location.href.substring(0, window.location.href.lastIndexOf("/") + 1);
        linkRecibo = `${base}recibo.html?n=${encodeURIComponent(cli)}&m=${encodeURIComponent(mod)}&t=${encodeURIComponent(tipo)}&p=${pre}`;

        const qr = document.getElementById('qrcode');
        qr.innerHTML = ""; qr.style.display = "block";
        new QRCode(qr, { text: linkRecibo, width: 140, height: 140 });
        document.getElementById('btn-wa').style.display = "block";
        actualizarTodo();
    }

    function actualizarTodo() {
        actualizarStock();
        const v = JSON.parse(localStorage.getItem('VENTAS_DB')) || [];
        const db = JSON.parse(localStorage.getItem('STOCK_DB')) || [];

        // Select de Ventas
        document.getElementById('sel-prod').innerHTML = '<option value="">-- Solo Mano de Obra --</option>' + 
            db.map(i => `<option value="${i.id}" data-p="${i.pre}">${i.nom} ($${i.pre})</option>`).join('');

        // Estados
        document.getElementById('lista-estados').innerHTML = v.slice().reverse().map(x => `
            <div class="card-info" style="border-left-color:${x.estado=='listo'?'var(--green)':'#f59e0b'}">
                <b>${x.cli}</b> - <small>${x.mod}</small><br>
                <div style="margin-top:10px">
                    <button onclick="cambiarEstado(${x.id}, 'proceso')">üîß</button>
                    <button onclick="cambiarEstado(${x.id}, 'listo')">‚úÖ</button>
                </div>
            </div>`).join('');

        // Caja
        const h = new Date(); let m=0; let a=0;
        v.forEach(x => {
            let f = new Date(x.f);
            if(f.getFullYear() === h.getFullYear()) { a += x.pre; if(f.getMonth() === h.getMonth()) m += x.pre; }
        });
        document.getElementById('m-val').innerText = "$" + m.toLocaleString();
        document.getElementById('a-val').innerText = "$" + a.toLocaleString();
    }

    function cambiarEstado(id, nuevo) {
        let v = JSON.parse(localStorage.getItem('VENTAS_DB'));
        v = v.map(x => { if(x.id == id) x.estado = nuevo; return x; });
        localStorage.setItem('VENTAS_DB', JSON.stringify(v));
        actualizarTodo();
    }

    function borrarTodo() { if(confirm("¬øBorrar toda la caja?")) { localStorage.removeItem('VENTAS_DB'); actualizarTodo(); } }
    
    function tab(id, e) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); e.target.classList.add('active');
    }

    function autoPrecio() {
        const sel = document.getElementById('sel-prod');
        const precio = sel.options[sel.selectedIndex].dataset.p;
        if(precio) document.getElementById('pre').value = precio;
    }
    
    function enviarWA() {
        const tel = document.getElementById('tel').value;
        window.open(`https://wa.me/${tel}?text=${encodeURIComponent("Recibo de Soporte Tech: " + linkRecibo)}`);
    }
</script>
</body>
